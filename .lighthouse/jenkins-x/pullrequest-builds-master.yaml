apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  creationTimestamp: null
  name: pullrequest
spec:
  pipelineSpec:
    tasks:
      - name: bifrost-master-builds
        resources: {}
        taskSpec:
          metadata: {}
          stepTemplate:
            imagePullPolicy: 'IfNotPresent'
            env:
              - name: HOME
                value: /tekton/home
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: /secret/kaniko.json
              - name: GOOGLE_ANALYTICS_ID
                value: UA-XXXXXXXX-X
              - name: DISABLE_SENTRY
                value: 'true'
            envFrom:
              - secretRef:
                  name: jx-boot-job-env-vars
                  optional: true
              - secretRef:
                  name: zeal-secret
              - secretRef:
                  name: stripe-publishable
            name: ''
          steps:
            - image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.27.0
              name: git-clone
              resources: {}
              script: |
                #!/bin/sh
                export SUBDIR="source"
                echo "git cloning url: $REPO_URL version $PULL_BASE_REF@$PULL_BASE_SHA to dir: $SUBDIR"
                git config --global user.name ${GIT_AUTHOR_NAME:-jenkins-x-bot}
                git config --global user.email ${GIT_AUTHOR_EMAIL:-jenkins-x@googlegroups.com}
                git config --global credential.helper store
                git clone $REPO_URL $SUBDIR
                cd $SUBDIR
                git reset --hard $PULL_BASE_SHA
                echo "checked out revision: $PULL_BASE_REF@$PULL_BASE_SHA to dir: $SUBDIR"
              workingDir: /workspace
            - image: ghcr.io/jenkins-x/jx-boot:3.2.157
              name: jx-variables
              resources: {}
              script: |
                #!/usr/bin/env sh
                jx gitops variables
              workingDir: /workspace/source
            - name: warm-cache
              image: gcr.io/kaniko-project/warmer:latest
              args:
                - --cache-dir=/kanikocache
                - --image=node:14.19-alpine
              workingDir: /workspace/source
            - image: gcr.io/kaniko-project/executor:v1.6.0-debug
              name: container-build
              script: |
                #!/busybox/sh
                source .jx/variables.sh
                /kaniko/executor --build-arg=GOOGLE_ANALYTICS_ID=UA-XXXXXXXX-X --build-arg=DISABLE_SENTRY=true --build-arg=ZEAL_SECRET=$ZEAL_SECRET --build-arg=STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY --context=/workspace/source --dockerfile=Dockerfile --destination=us.gcr.io/deepsource-dev/$REPO_NAME:master --cache=true --snapshotMode=redo --cache-dir=/kanikocache
              workingDir: /workspace/source
          workspaces:
            - name: kanikocache
              mountPath: /kanikocache
            - name: kaniko
              mountPath: /secret
        workspaces:
          - name: kanikocache
            workspace: bifrost-cache
            subPath: kanikocache
          - name: kaniko
            workspace: kaniko
    workspaces:
      - name: bifrost-cache
      - name: kaniko
  workspaces:
    - name: bifrost-cache
      persistentVolumeClaim:
        claimName: bifrost-cache
    - name: kaniko
      secret:
        secretName: kaniko
    - name: zeal
      secret:
        secretName: zeal-secret
    - name: stripe
      secret:
        secretName: stripe-publishable
  podTemplate:
    nodeSelector:
      scheduledBy: jx
  serviceAccountName: tekton-bot
  timeout: 12h0m0s
status: {}
